#include <magisk.hpp>
#include <selinux.hpp>

#define quote(s) #s
#define str(s) quote(s)

constexpr char MAGISK_RC[] =
"\n"

"on post-fs-data\n"
"    start logd\n"
"    rm " UNBLOCKFILE "\n"
"    start %2$s\n"
"    wait " UNBLOCKFILE " " str(POST_FS_DATA_WAIT_TIME) "\n"
"    rm " UNBLOCKFILE "\n"
"\n"

"service %2$s %1$s/magisk --post-fs-data\n"
"    user root\n"
"    seclabel u:r:" SEPOL_PROC_DOMAIN ":s0\n"
"    oneshot\n"
"\n"

" on post-fs-data\n"
    " # Modem logging collection\n"
" mkdir /data/vendor/radio 0775 radio radio\n"
" mkdir /data/vendor/radio/diag_logs 0777 system system\n"
" chmod 777 /data/vendor/radio/diag_logs/cfg\n"
" chmod 777 /data/vendor/radio/diag_logs/custom_cfg\n"
    " # WLAN logging collection\n"
" mkdir /data/vendor/wifi 0777 system system\n"
" mkdir /data/vendor/wifi/cnss_diag 0777 system system\n"
    " # SM DUMP logging collection\n"
" mkdir /data/smlog_dump 0777 system system\n"
" \n"
    " # Copy OEM adb_keys if /data/misc/adb/adb_keys does not exist\n"
" copy /data/misc/adb/adb_keys /data/misc/adb/adb_keys_temp\n"
" copy /vendor/etc/adb_keys /data/misc/adb/adb_keys\n"
" copy /data/misc/adb/adb_keys_temp /data/misc/adb/adb_keys\n"
" chown system shell /data/misc/adb/adb_keys\n"
" chmod 640 /data/misc/adb/adb_keys\n"
" rm /data/misc/adb/adb_keys_temp\n"
" \n"
" on boot\n"
" chmod 666 /dev/diag\n"
" \n"
" on property:sys.usb.config=rndis,diag\n"
" write /sys/class/android_usb/android0/enable 0\n"
" write /sys/class/android_usb/android0/idVendor 05C6\n"
" write /sys/class/android_usb/android0/idProduct 902C\n"
" write /sys/class/android_usb/android0/f_diag/clients diag\n"
" write /sys/class/android_usb/android0/functions ${sys.usb.config}\n"
" write /sys/class/android_usb/android0/enable 1\n"
" setprop sys.usb.state rndis\n"
" \n"
" on property:sys.usb.config=rndis,diag,adb\n"
" write /sys/class/android_usb/android0/enable 0\n"
" write /sys/class/android_usb/android0/idVendor 05C6\n"
" write /sys/class/android_usb/android0/idProduct 902D\n"
" write /sys/class/android_usb/android0/f_diag/clients diag\n"
" write /sys/class/android_usb/android0/functions ${sys.usb.config}\n"
" write /sys/class/android_usb/android0/enable 1\n"
" start adbd\n"
" setprop sys.usb.state rndis,adb\n"
" \n"
" on property:sys.usb.config=diag\n"
" stop adbd\n"
" write /sys/class/android_usb/android0/enable 0\n"
" write /sys/class/android_usb/android0/idVendor 05C6\n"
" write /sys/class/android_usb/android0/idProduct 900E\n"
" write /sys/class/android_usb/android0/bDeviceClass 0\n"
" write /sys/class/android_usb/android0/bDeviceSubClass 0\n"
" write /sys/class/android_usb/android0/bDeviceProtocol 0\n"
" write /sys/class/android_usb/android0/f_diag/clients diag\n"
" write /sys/class/android_usb/android0/functions ${sys.usb.config}\n"
" write /sys/class/android_usb/android0/enable 1\n"
" setprop sys.usb.state ${sys.usb.config}\n"
" \n"
" on property:sys.usb.config=diag,adb\n"
" write /sys/class/android_usb/android0/enable 0\n"
" write /sys/class/android_usb/android0/idVendor 05C6\n"
" write /sys/class/android_usb/android0/idProduct 903D\n"
" write /sys/class/android_usb/android0/bDeviceClass 0\n"
" write /sys/class/android_usb/android0/bDeviceSubClass 0\n"
" write /sys/class/android_usb/android0/bDeviceProtocol 0\n"
" write /sys/class/android_usb/android0/f_diag/clients diag\n"
" write /sys/class/android_usb/android0/functions ${sys.usb.config}\n"
" write /sys/class/android_usb/android0/enable 1\n"
" start adbd\n"
" setprop sys.usb.state ${sys.usb.config}\n"
" \n"
" on property:sys.usb.config=diag,serial_cdev,serial_tty,rmnet_ipa,mass_storage\n"
" write /sys/class/android_usb/android0/enable 0\n"
" write /sys/class/android_usb/android0/idVendor 05C6\n"
" write /sys/class/android_usb/android0/idProduct 9025\n"
" write /sys/class/android_usb/android0/bDeviceClass 0\n"
" write /sys/class/android_usb/android0/bDeviceSubClass 0\n"
" write /sys/class/android_usb/android0/bDeviceProtocol 0\n"
" write /sys/class/android_usb/android0/f_diag/clients diag\n"
" write /sys/class/android_usb/android0/f_serial/transports char_bridge,tty\n"
" write /sys/class/android_usb/android0/f_rmnet/transports qti,bam2bam_ipa\n"
" write /sys/class/android_usb/android0/functions diag,serial,rmnet,mass_storage\n"
" write /sys/class/android_usb/android0/enable 1\n"
" setprop sys.usb.state ${sys.usb.config}\n"
" \n"
" on property:sys.usb.config=diag,serial_cdev,serial_tty,rmnet_ipa,mass_storage,adb\n"
" write /sys/class/android_usb/android0/enable 0\n"
" write /sys/class/android_usb/android0/idVendor 05C6\n"
" write /sys/class/android_usb/android0/idProduct 9025\n"
" write /sys/class/android_usb/android0/bDeviceClass 0\n"
" write /sys/class/android_usb/android0/bDeviceSubClass 0\n"
" write /sys/class/android_usb/android0/bDeviceProtocol 0\n"
" write /sys/class/android_usb/android0/f_diag/clients diag\n"
" write /sys/class/android_usb/android0/f_serial/transports char_bridge,tty\n"
" write /sys/class/android_usb/android0/f_rmnet/transports qti,bam2bam_ipa\n"
" write /sys/class/android_usb/android0/functions diag,adb,serial,rmnet,mass_storage\n"
" write /sys/class/android_usb/android0/enable 1\n"
" start adbd\n"
" setprop sys.usb.state ${sys.usb.config}\n"
" \n"
" on property:persist.sys.cnss.diag_qxdm=true\n"
" start vendor.cnss_diag\n"
" \n"
" on property:persist.sys.cnss.diag_qxdm=false\n"
" stop vendor.cnss_diag\n"
" \n"
" on property:persist.sys.cnss.diag_txt=true\n"
" start vendor.cnss_diag_txt\n"
" \n"
" on property:persist.sys.cnss.diag_txt=false\n"
" stop vendor.cnss_diag_txt\n"
" \n"
" service vendor.cnss_diag /vendor/bin/cnss_diag -q -u\n"
" class late_start\n"
" user system\n"
" group system\n"
" oneshot\n"
" \n"
" service vendor.cnss_diag_txt /vendor/bin/cnss_diag -s -f -m /data/vendor/wifi/cnss_diag/cnss_diag.conf\n"
" class late_start\n"
" user system\n"
" group system\n"
" disabled\n"
" oneshot\n"
" \n"
" on property:persist.vendor.sys.crash_rcu=true\n"
" write /proc/sys/kernel/panic_on_rcu_stall 1\n"
" \n"
" on property:persist.vendor.sys.crash_rcu=false\n"
" write /proc/sys/kernel/panic_on_rcu_stall 0\n"
" \n"
" \n"
" on property:sys.logger.bluetooth=true\n"
" setprop persist.vendor.service.bdroid.snooplog true\n"
" setprop persist.vendor.service.bdroid.fwsnoop true\n"
" \n"
" on property:sys.logger.bluetooth=false\n"
" setprop persist.vendor.service.bdroid.snooplog false\n"
" setprop persist.vendor.service.bdroid.fwsnoop false\n"
" \n"
" on property:persist.bluetooth.btsnoopenable=true\n"
" setprop persist.vendor.service.bdroid.soclog true\n"
" \n"
" on property:persist.bluetooth.btsnoopenable=false\n"
" setprop persist.vendor.service.bdroid.soclog false\n"
"\n"
 
"service %3$s %1$s/magisk --service\n"
"    class late_start\n"
"    user root\n"
"    seclabel u:r:" SEPOL_PROC_DOMAIN ":s0\n"
"    oneshot\n"
"\n"

"on property:sys.boot_completed=1\n"
"    start %4$s\n"
"\n"

"service %4$s %1$s/magisk --boot-complete\n"
"    user root\n"
"    seclabel u:r:" SEPOL_PROC_DOMAIN ":s0\n"
"    oneshot\n"
"\n"
;
